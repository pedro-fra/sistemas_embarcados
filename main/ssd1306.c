#include "ssd1306.h"
#include <string.h>
#include <stdio.h>
#include "esp_log.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"

#define SSD1306_ADDR 0x3C
#define I2C_MASTER_NUM 0
#define I2C_MASTER_TIMEOUT_MS 1000

static const char *TAG = "SSD1306";
static uint8_t display_buffer[SSD1306_WIDTH * SSD1306_HEIGHT / 8] = {0};

static const uint8_t font5x8[][5] = {
    {0x00, 0x00, 0x00, 0x00, 0x00}, // space
    {0x00, 0x00, 0x5f, 0x00, 0x00}, // !
    {0x00, 0x07, 0x00, 0x07, 0x00}, // "
    {0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
    {0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
    {0x23, 0x13, 0x08, 0x64, 0x62}, // %
    {0x36, 0x49, 0x55, 0x22, 0x50}, // &
    {0x00, 0x05, 0x03, 0x00, 0x00}, // '
    {0x00, 0x1c, 0x22, 0x41, 0x00}, // (
    {0x00, 0x41, 0x22, 0x1c, 0x00}, // )
    {0x14, 0x08, 0x3e, 0x08, 0x14}, // *
    {0x08, 0x08, 0x3e, 0x08, 0x08}, // +
    {0x00, 0x50, 0x30, 0x00, 0x00}, // ,
    {0x08, 0x08, 0x08, 0x08, 0x08}, // -
    {0x00, 0x60, 0x60, 0x00, 0x00}, // .
    {0x20, 0x10, 0x08, 0x04, 0x02}, // /
    {0x3e, 0x51, 0x49, 0x45, 0x3e}, // 0
    {0x00, 0x42, 0x7f, 0x40, 0x00}, // 1
    {0x42, 0x61, 0x51, 0x49, 0x46}, // 2
    {0x21, 0x41, 0x45, 0x4b, 0x31}, // 3
    {0x18, 0x14, 0x12, 0x7f, 0x10}, // 4
    {0x27, 0x45, 0x45, 0x45, 0x39}, // 5
    {0x3c, 0x4a, 0x49, 0x49, 0x30}, // 6
    {0x01, 0x71, 0x09, 0x05, 0x03}, // 7
    {0x36, 0x49, 0x49, 0x49, 0x36}, // 8
    {0x06, 0x49, 0x49, 0x29, 0x1e}, // 9
    {0x00, 0x36, 0x36, 0x00, 0x00}, // :
    {0x00, 0x56, 0x36, 0x00, 0x00}, // ;
    {0x08, 0x14, 0x22, 0x41, 0x00}, // <
    {0x14, 0x14, 0x14, 0x14, 0x14}, // =
    {0x00, 0x41, 0x22, 0x14, 0x08}, // >
    {0x02, 0x01, 0x51, 0x09, 0x06}, // ?
    {0x32, 0x49, 0x79, 0x41, 0x3e}, // @
    {0x7e, 0x11, 0x11, 0x11, 0x7e}, // A
    {0x7f, 0x49, 0x49, 0x49, 0x36}, // B
    {0x3e, 0x41, 0x41, 0x41, 0x22}, // C
    {0x7f, 0x41, 0x41, 0x22, 0x1c}, // D
    {0x7f, 0x49, 0x49, 0x49, 0x41}, // E
    {0x7f, 0x09, 0x09, 0x09, 0x01}, // F
    {0x3e, 0x41, 0x49, 0x49, 0x7a}, // G
    {0x7f, 0x08, 0x08, 0x08, 0x7f}, // H
    {0x00, 0x41, 0x7f, 0x41, 0x00}, // I
    {0x20, 0x40, 0x41, 0x3f, 0x01}, // J
    {0x7f, 0x08, 0x14, 0x22, 0x41}, // K
    {0x7f, 0x40, 0x40, 0x40, 0x40}, // L
    {0x7f, 0x02, 0x0c, 0x02, 0x7f}, // M
    {0x7f, 0x04, 0x08, 0x10, 0x7f}, // N
    {0x3e, 0x41, 0x41, 0x41, 0x3e}, // O
    {0x7f, 0x09, 0x09, 0x09, 0x06}, // P
    {0x3e, 0x41, 0x51, 0x21, 0x5e}, // Q
    {0x7f, 0x09, 0x19, 0x29, 0x46}, // R
    {0x46, 0x49, 0x49, 0x49, 0x31}, // S
    {0x01, 0x01, 0x7f, 0x01, 0x01}, // T
    {0x3f, 0x40, 0x40, 0x40, 0x3f}, // U
    {0x1f, 0x20, 0x40, 0x20, 0x1f}, // V
    {0x3f, 0x40, 0x38, 0x40, 0x3f}, // W
    {0x63, 0x14, 0x08, 0x14, 0x63}, // X
    {0x07, 0x08, 0x70, 0x08, 0x07}, // Y
    {0x61, 0x51, 0x49, 0x45, 0x43}, // Z
};

static esp_err_t ssd1306_write_command(uint8_t command)
{
    uint8_t data[2] = {0x80, command};
    return i2c_master_write_to_device(I2C_MASTER_NUM, SSD1306_ADDR, data, 2,
                                     I2C_MASTER_TIMEOUT_MS / portTICK_PERIOD_MS);
}

static esp_err_t ssd1306_write_data(uint8_t* data, size_t len)
{
    uint8_t write_buf[len + 1];
    write_buf[0] = 0x40;
    memcpy(&write_buf[1], data, len);
    return i2c_master_write_to_device(I2C_MASTER_NUM, SSD1306_ADDR, write_buf, len + 1,
                                     I2C_MASTER_TIMEOUT_MS / portTICK_PERIOD_MS);
}

esp_err_t ssd1306_init(void)
{
    esp_err_t ret = ESP_OK;
    
    ret |= ssd1306_write_command(0xAE);
    ret |= ssd1306_write_command(0xD5);
    ret |= ssd1306_write_command(0x80);
    ret |= ssd1306_write_command(0xA8);
    ret |= ssd1306_write_command(0x3F);
    ret |= ssd1306_write_command(0xD3);
    ret |= ssd1306_write_command(0x00);
    ret |= ssd1306_write_command(0x40);
    ret |= ssd1306_write_command(0x8D);
    ret |= ssd1306_write_command(0x14);
    ret |= ssd1306_write_command(0x20);
    ret |= ssd1306_write_command(0x00);
    ret |= ssd1306_write_command(0xA1);
    ret |= ssd1306_write_command(0xC8);
    ret |= ssd1306_write_command(0xDA);
    ret |= ssd1306_write_command(0x12);
    ret |= ssd1306_write_command(0x81);
    ret |= ssd1306_write_command(0xCF);
    ret |= ssd1306_write_command(0xD9);
    ret |= ssd1306_write_command(0xF1);
    ret |= ssd1306_write_command(0xDB);
    ret |= ssd1306_write_command(0x40);
    ret |= ssd1306_write_command(0xA4);
    ret |= ssd1306_write_command(0xA6);
    ret |= ssd1306_write_command(0xAF);
    
    if (ret == ESP_OK) {
        ESP_LOGI(TAG, "SSD1306 inicializado com sucesso");
    }
    
    return ret;
}

esp_err_t ssd1306_clear_screen(void)
{
    memset(display_buffer, 0, sizeof(display_buffer));
    return ssd1306_update_display();
}

esp_err_t ssd1306_display_text(uint8_t line, const char* text)
{
    if (line >= 8) return ESP_ERR_INVALID_ARG;
    
    int x = 0;
    int y = line;
    
    for (int i = 0; text[i] != '\0' && x < (SSD1306_WIDTH / 6); i++) {
        char c = text[i];
        int char_index;
        
        if (c >= ' ' && c <= 'Z') {
            char_index = c - ' ';
        } else {
            char_index = 0;
        }
        
        for (int col = 0; col < 5; col++) {
            uint8_t column_data = font5x8[char_index][col];
            int buffer_index = (y * SSD1306_WIDTH) + (x * 6) + col;
            if (buffer_index < sizeof(display_buffer)) {
                display_buffer[buffer_index] = column_data;
            }
        }
        x++;
    }
    
    return ESP_OK;
}

esp_err_t ssd1306_update_display(void)
{
    esp_err_t ret = ESP_OK;
    
    for (int page = 0; page < 8; page++) {
        ret |= ssd1306_write_command(0xB0 + page);
        ret |= ssd1306_write_command(0x00);
        ret |= ssd1306_write_command(0x10);
        
        ret |= ssd1306_write_data(&display_buffer[page * SSD1306_WIDTH], SSD1306_WIDTH);
    }
    
    return ret;
}